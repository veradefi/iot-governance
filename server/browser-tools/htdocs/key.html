<html lang="en">
<head>
<link rel="stylesheet" type="text/css" href="css/diQuery-collapsiblePanel.css">
<script src="js/jquery-1.9.1.min.js"></script>
<script src="js/jquery.scrollTo-1.4.2-min.js"></script>
<script type="text/javascript" src="js/URI.js"></script>
<script type="text/javascript" src="js/base64.js"></script>
<script type="text/javascript" src="js/api.js"></script>
<link rel="stylesheet" type="text/css" href="css/style.bundle.css">
<link rel="stylesheet" type="text/css" href="css/vendors.bundle.css">
<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js"></script>

<script>
  WebFont.load({
    google: {"families":["Poppins:300,400,500,600,700","Roboto:300,400,500,600,700"]},
    active: function() {
        sessionStorage.fonts = true;
    }
  });
</script>
</head>
<body>

<form id="header">
<div class="row">
     <div class="col-md-12">
         <center>
          <a href="https://iotblock.io">
        <img src="logo-32x32.png" style="float: right;width:81px;" border=0>
        </a>
        <div class="btn-group m-btn-group m-btn-group--pill">
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="pool.html">Smart Pool Key</a>
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="key.html">Smart Key</a>
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="browser.html">Catalogue browser and editor (text)</a>
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="explorer.html">Catalogue explorer (graphical)</a>
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="crawler.html">Catalogue crawler (graphical)</a>
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="map.html">Catalogue Map</a>
            <!--
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="validator.html">Catalogue syntax validator</a></li>
            //-->
        </div>
           </center>
    </div>
</div>
</form>
<form id="page1" style="display:none;">

<!--
<div class="row">
     <div class="col-md-12">
            <div class="m-portlet m-portlet--tab">
                   <div class="m-portlet__head">
                          <br>
                          <center><label><h3>Find Smart Key</h3></label></center>
                          <div class="row">
                                 <div class="col-md-12">
                                         <center>
                                         
                                             <input name="find_poolkey" class="form-control m-input m-input--air m-input--pill"  placeholder="Enter Smart Key Address" style="width:50%" type="text" id="find_poolkey" placeholder="" aria-invalid="false" aria-required="false">
                                             <br>
                                             <button type="button" id='find_poolkey_btn' class="btn btn-accent"><h1>Find My Smart Key</h1></button>
                                          </center>
                                          <br>
                                  </div>
                            </div>
 
                      </div>
                </div>
            
     </div>
</div>
//-->

<div class="row">
     <div class="col-md-12">
              <center><label><h3>Create Smart Key</h3></label></center>
              <div class="row">
                     <div class="col-md-12">
                             <center>
                             
                                  <label><h5>Your wallet address</h5></label>
                                 <input name="address" class="address_val form-control m-input m-input--air m-input--pill"  style="width:50%" type="text" id="address" placeholder="" aria-invalid="false" aria-required="false">
                              </center>
                      </div>
                </div>
 
            <hr>
            
     </div>
</div>

<div class="row">
    <div class="col-md-12">    
        <div class="m-portlet m-portlet--tab">
               <div class="m-portlet__head">
                    <center>
<!--
            
                    <hr>
            
                    <div class="row">
                        <div class="col-md-12">
            
                          <h3>
                            Admins
                          </h3>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6" align=right>
                
                          <label>Admin 1 Wallet Address</label>
                          
                        </div>
                        <div class="col-md-6" align=left>
                          
                          <input name="admin1" class="address_val form-control m-input m-input--air m-input--pill"  type="text" id="admin1" placeholder="" aria-invalid="false" aria-required="false">
                      
                         </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6" align=right>
                
                          <label>Admin 2 Wallet Address</label>
                        </div>
                        <div class="col-md-6" align=left>
                            <input name="admin2" class="form-control m-input m-input--air m-input--pill"  matinput="" type="text" id="admin2" placeholder="" aria-invalid="false" aria-required="false">
                        </div>
                    </div>
                      
                    <div class="row">
                        <div class="col-md-6" align=right>
                
                          <label>Admin 3 Wallet Address</label>
                        </div>
                        <div class="col-md-6" align=left>
                            <input name="admin3" class="form-control m-input m-input--air m-input--pill"  matinput="" type="text" id="admin3" placeholder="" aria-invalid="false" aria-required="false">
                        </div>
                    </div>
                    
                    <hr>
-->                    
                    <div class="row">
                        <div class="col-md-12">
                          <h3>Ether</h3>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6" align=right>    
                          <label>Minimum Ether Needed</label>
                        </div>
                        <div class="col-md-6" align=left>
                           1 ETH                           
                        </div>
                    </div>
                    <br>
                    
                    <hr>
            
                    <div class="row">
                        <div class="col-md-12">    
                            <button type="button" id='pool' class="btn btn-accent"><h1>Create Smart Key</h1></button>
                            <br><br>
                        </div>
                    </div>
                    </center>
            </div>
        </div>
    </div>
</div>
            

</form>
<form id="loading" >
<img src="images/wait.gif">
</form>
<form id="page2" style="display:none;">
<div class="row">
    <div class="col-md-12">    
        <center><h3>Smart Key Contract Address</h3></center><br>
    </div>
</div>
<div class="row">
    <div class="col-md-12">    

        <center><h3><pre id='poolkey'></pre></h3></center>

    </div>
</div>

<div class="row">
    <div class="col-md-12">    
        <hr>
    </div>
</div>
<div class="row">
    <div class="col-md-6">    
        <div class="m-portlet m-portlet--tab">
               <div class="m-portlet__head">
        
                    <br><br>                    
                    
                    <div class="row">
                        <div class="col-md-6">    
                            
                            <h3>TOKEN BALANCE</h3>
                            <div class="row">
                                <div class="col-md-12">
                                    <h3><span class="token_balance"></span></h3>
                                    <font size=2>TOKENS</font><br>
                                </div>
                            </div>                            
                            
                            
                        </div>
                        <div class="col-md-6">    
                            
                            <h3>ETH BALANCE</h3>
                            <h3><span class="eth_balance"></span></h3> <font size=2>ETH</font>

                            
                        </div>
                    </div>
                   
                    <div class="row">
                        <div class="col-md-12">
                                <br><br>
                                <h4>
                                     
                                     <div class="progress m-progress--sm">
                						<div class="progress-bar m--bg-accent" role="progressbar" style="height:35px;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                						<b><span class="eth_sent"></b>
                						</div>
                					</div>
                                    
                                </h4>
                                <br><br>
                        </div>
                    </div>
                    
                     <div class="row">
                        <div class="col-md-6">    
                            <h3 class='status'>Health Status</h3>
                            <h1><span class='health'></span></h1>
                            <br><br><br><br><br>
                        </div>
                        <div class="col-md-6">    
                            <h3>Key State</h3>
                            <h1>    
                            <span class="state"></span>   
                            </h1> <font size=2></font><br>
                            
                        </div>
                    </div>
                </div>
              </div>
             </div>
             <div class="col-md-6">    
                    <div class="m-portlet m-portlet--tab">
                           <div class="m-portlet__head">     
                               <br><br>
                               <div class="row>
                                   <div class="col-md-12">
                                        <h3>Vault
                                        <pre><span class="vault"></span> <font size=2></font>
                                        </h3>
                                       <div id="contrib-stat" style="height: 200px;"></div>
                                       
                                    </div>
                                    
                                    <div class="col-md-12" id="eth_transfer">
                                        <div class="row">
                                            <div class="col-md-4">
                                                ETH Amount:<br>
                                                <input id='send_amt' class="form-control m-input m-input--air m-input--pill" value=1>
                                            </div>
                                            <div class="col-md-4">
                                                Beneficiary Address:<br>
                                                <input id='beneficiary' class="address_val form-control m-input m-input--air m-input--pill" placeholder="Beneficiary Address">
                                            </div>
                                            <div class="col-md-4">
                                                <br>
                                                <a href='#eth_transfer' onClick="JavaScript:get_transfer_user_eth($('#beneficiary').val(), $('#send_amt').val())" class="btn m-btn--pill m-btn--air         btn-outline-info" id='wd_ether'>Transfer Ether</a>
                                            </div>
                                        </div>
                                        <br>
                                        
                                    </div>
                                    <div id="eth_transfer_loading" style="display:none">
                                    <center><img src="images/wait.gif" width=100></center>
                                    </div>

                                </div>                              
    
                            </div>
                    </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div id="health">
                <center>
                <h3>Update Device Integrity Status</h3>
                <div class="m-btn-group m-btn-group--pill btn-group m-btn-group m-btn-group--pill btn-group-lg">
                    <button onClick="JavaScript:setHealth(0)" type="button" class="btn btn-primary">Provisioning</button>
                    <button onClick="JavaScript:setHealth(1)" type="button" class="btn btn-success">Certified</button>
                    <button onClick="JavaScript:setHealth(2)" type="button" class="btn btn-info">Modified</button>
                    <button onClick="JavaScript:setHealth(3)" type="button" class="btn btn-danger">Compromised</button>
                    <button onClick="JavaScript:setHealth(4)" type="button" class="btn btn-danger">Malfunctioning</button>
                    <button onClick="JavaScript:setHealth(5)" type="button" class="btn btn-danger">Harmful</button>
                    <button onClick="JavaScript:setHealth(6)" type="button" class="btn btn-danger">Counterfeit</button>
                </div>
                </center>
                </div>
                <div id="health_loading" style="display:none">
                <center><img src="images/wait.gif" width=100></center>
                </div>
                <br><br><br>    
            </div>
        </div> 
        
        <div class="row">
            <div class="col-md-12">
                <div class="m-portlet m-portlet--tab">
                           <div class="m-portlet__head">
                               <br>
                               <center><h3>Transactions</h3></center> 
                                <hr>
                               <div id='transactions'>
                               </div>
                           </div>
                </div>
            </div>
        </div>
    </div>
</div>            


</form>
<script>
var isSmartKey=true;
var myAddress='0x0';
var keyAddress='0x0';

function get_smart_key_info(address) {

    
    $.ajax({
            //beforeSend: function(xhr){setHeaders(xhr);},
            type: 'GET',
            url: '/cat/getSmartKey?address=' + encodeURI(address),
            //data: JSON.stringify(user_item),
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            success: function(body, textStatus, xhr) {
                fill_page2(address, body["address"], body["balance"], body["eth_recv"], body["vault"], body["state"], body["health"], body["tokens"]);
            },
            error: function(xhr, textStatus, err) {
                log(xhr.status + ' ' + xhr.statusText);
            }
        });
}


function get_smartkey_transactions(address) {
   $.ajax({
            //beforeSend: function(xhr){setHeaders(xhr);},
            type: 'GET',
            url: '/cat/getSmartKeyTx?address=' + encodeURI(address),
            //data: JSON.stringify(user_item),
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            success: function(body, textStatus, xhr) {
                var transactions=body["transactions"];
                for (var i=0; i < transactions.length; i++) {
                    var sender=transactions[i]["sender"];
                    var date=transactions[i]["date"];
                    var amount=transactions[i]["amount"];
                    fill_page2_transactions(sender, date, amount)
                }
            },
            error: function(xhr, textStatus, err) {
                log(xhr.status + ' ' + xhr.statusText);
            }
        });
}


function get_transfer_user_eth(beneficiary, amount) {
   var eth1=1000000000000000000;
   var amt=parseFloat(amount) * eth1;
   $('#eth_transfer').hide();
   $('#eth_transfer_loading').show();
   $.ajax({
            //beforeSend: function(xhr){setHeaders(xhr);},
            type: 'GET',
            url: '/cat/transferUserEth?address=' + encodeURI(myAddress) + '&beneficiary=' + encodeURI(beneficiary) + '&amount=' + encodeURI(amt),
            //data: JSON.stringify(user_item),
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            success: function(body, textStatus, xhr) {
               $('#eth_transfer').show();
               $('#eth_transfer_loading').hide();
                fill_page2(myAddress, body["address"], body["balance"], body["eth_recv"], body["vault"], body["state"], body["health"], body["tokens"]);
            },
            error: function(xhr, textStatus, err) {
               $('#eth_transfer').show();
               $('#eth_transfer_loading').hide();
                log(xhr.status + ' ' + xhr.statusText);
            }
        });
}


function setHealth(health) {
   var health=parseInt(health)
   $('#health').hide();
   $('#health_loading').show();
   $.ajax({
            //beforeSend: function(xhr){setHeaders(xhr);},
            type: 'GET',
            url: '/cat/setUserHealth?address=' + encodeURI(myAddress) + '&health=' + encodeURI(health),
            //data: JSON.stringify(user_item),
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            success: function(body, textStatus, xhr) {
               $('#health').show();
               $('#health_loading').hide();
                fill_page2(myAddress, body["address"], body["balance"], body["eth_recv"], body["vault"], body["state"], body["health"], body["tokens"]);
            },
            error: function(xhr, textStatus, err) {
               $('#health').show();
               $('#health_loading').hide();
                log(xhr.status + ' ' + xhr.statusText);
            }
        });
}

function fill_page2(userAddress, address, balance, eth_recv, vault, state, health, tokens) {
   console.log(userAddress, address, balance, eth_recv, vault, state, health, tokens);
   $('#loading').show();
   $('#page1').hide();
   $('#page2').hide();

    if (address == '0' || address == '0x0000000000000000000000000000000000000000') {
        $('#page1').show();
        $('#loading').hide();
        $('#page2').hide();
        return;
    } else {
       myAddress=userAddress;
       keyAddress=address;
       var eth1_amount=1000000000000000000       
       balance/=eth1_amount;
       eth_recv/=eth1_amount;
       tokens/=eth1_amount;
       var states=[ 'Issued', 'Active', 'Returned' ]
       var healthStates = ['Provisioning', 'Certified', 'Modified', 'Compromised', 'Malfunctioning', 'Harmful', 'Counterfeit' ]
       
       //$('#page1').hide();
       $('#loading').hide();
       $('#page2').show();
       
       $('.token_balance').html(tokens);
       $('.eth_balance').html(balance);
       $('.eth_received').html(eth_recv);
       $('.vault').html( vault );
       $('.state').html( states[state] );
       $('.health').html( healthStates[health] );
       $('.progress-bar').val( balance / eth_recv * 100 );
       $('#poolkey').html('<pre>' + address + '</pre>');
       
       $('#contrib-stat').html('');
       Morris.Donut({
          element: 'contrib-stat',
          data: [
            {label: "Received ETH", value:  eth_recv},
            {label: "Available ETH", value:  balance},
          ]
        });
        
         
        $('#send_ether').on('click', function(e) {
               var eth1=1000000000000000000;
               var amt=parseInt($('#send_amt').val()) * eth1;
               send_ether(address, amt);
       });       
   }
   $('#transactions').html('');
   get_smartkey_transactions(userAddress);

   
}  

function fill_page2_transactions(sender, date, amount) {
        console.log(sender, date, amount);
        var dateTime = new Date(parseInt(date) * 1000);
        date=dateTime.toISOString(); 
        var eth1=1000000000000000000;
        var html ="<div class=row><div class=col-md-4>";
        html +='<b>Date:</b><br> ' + date + "</div><div class=col-md-4>";
        html +='<b>Sender:</b><br> ' + sender + "</div><div class=col-md-4>";
        html +='<b>Amount:</b><br> ' + amount/eth1 + " ETH</div>";
        html +="</div><hr><br>";
        
        $('#transactions').append(html);
}
    


function page2(address) {

   get_smart_key_info(address);
}

$( document ).ready(function() {
    
    $('#fee').on('change', function(e) {
        $('#fee_struct').show();
        var you_msg = you + '%';
        
        var fee=parseFloat($('#fee').val());
        var you=fee - 0.5;
        $('#you').html(you_msg);
        var total_msg = fee  + '%';
        $('#total').html(total_msg);
                
        
    });
    
    $('#find_poolkey_btn').on('click',function(e) {
         var poolkey=$('#find_poolkey').val();
         page2(poolkey);
    });

    
    $('#pool').on('click', function (e) {
        var fee=Math.round(1 / parseFloat($('#fee').val() / 100));
        var whitelist=[];
        var admins=[];
        var has_whitelist=false;
        /*
        if ($('#whitelist1').val().length > 0) {
            whitelist.push($('#whitelist1').val());
        }
        if ($('#whitelist2').val().length > 0) {
            whitelist.push($('#whitelist2').val());
        }
        if ($('#whitelist3').val().length > 0) {
            whitelist.push($('#whitelist3').val());
        }
        if ($('#has_whitelist')[0].checked) {
            has_whitelist=true;
        }
        
        if ($('#admin1').val().length > 0) {
            admins.push($('#admin1').val());
        }
        if ($('#admin2').val().length > 0) {
            admins.push($('#admin2').val());
        }
        if ($('#admin3').val().length > 0) {
            admins.push($('#admin3').val());
        }
        var max_contrib=parseInt($('#max_contrib').val()) * eth1;
        var max_per_contrib=parseInt($('#max_per_contrib').val()) * eth1;
        var min_per_contrib=parseInt($('#min_per_contrib').val()) * eth1;
        */
        
        var eth1=1000000000000000000;
        
        var beneficiary=$('#address').val();
        function key_created(address) {
            myAddress=beneficiary;
            keyAddress=address;
            page2(myAddress);
        }
        add_smartkey(beneficiary, beneficiary, beneficiary, key_created); 
        
    });
    
   
});
</script>
<script src="js/app.js"></script>
</body></html>