<html>
<head>

<link rel="stylesheet" type="text/css" href="css/style.bundle.css">
<link rel="stylesheet" type="text/css" href="css/vendors.bundle.css">
<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>
        <script>
          WebFont.load({
            google: {"families":["Poppins:300,400,500,600,700","Roboto:300,400,500,600,700"]},
            active: function() {
                sessionStorage.fonts = true;
            }
          });
        </script>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script>
function validateMetadataArray(metadataArray, checkContentType) {
    var hasDescription = false;
    var hasContentType = false;
    for (var i=0;i<metadataArray.length;i++) {
        if (typeof metadataArray[i] != 'object')
            throw new Error("Metadata array does not contain an object: "+JSON.stringify(metadataArray[i]));
        if (metadataArray[i].rel === undefined)
            throw new Error("Metadata array object has no rel: "+JSON.stringify(metadataArray[i]));
        if (typeof metadataArray[i].rel != 'string')
            throw new Error("Metadata array object rel is not string: "+JSON.stringify(metadataArray[i]));
        if (metadataArray[i].rel === "")
            throw new Error("Metadata array object rel is empty "+JSON.stringify(metadataArray[i]));
        if (metadataArray[i].val === undefined)
            throw new Error("Metadata array object has no val: "+JSON.stringify(metadataArray[i]));
        if (typeof metadataArray[i].val != 'string')
            throw new Error("Metadata array object has no val string: "+JSON.stringify(metadataArray[i]));
        if (metadataArray[i].val === "")
            throw new Error("Metadata array object val is empty: "+JSON.stringify(metadataArray[i]));   // SmartStreets interpretation, to be ratified
        if (Object.keys(metadataArray[i]).length != 2)
            throw new Error("Metadata array object should have only two properties "+JSON.stringify(metadataArray[i]));
        if (metadataArray[i].rel == 'urn:X-tsbiot:rels:hasDescription:en')
            hasDescription = true;
        if (metadataArray[i].rel == 'urn:X-tsbiot:rels:isContentType' &&
            metadataArray[i].val == 'application/vnd.tsbiot.catalogue+json')
            hasContentType = true;
    }
    if (!hasDescription)
        throw new Error("Metadata array does not contain urn:X-tsbiot:rels:hasDescription:en: "+JSON.stringify(metadataArray));
    if (checkContentType && !hasContentType)
        throw new Error("Metadata array does not contain urn:X-tsbiot:rels:isContentType application/vnd.tsbiot.catalogue+json: "+JSON.stringify(metadataArray));
}

function validateItem(item) {
    // a valid item must have href and a metadata array
    if (item.href === undefined)
        throw new Error("Item href is missing: "+JSON.stringify(item));
    if (typeof item.href != 'string')
        throw new Error("Item href is not a string: "+JSON.stringify(item));
    if (item['i-object-metadata'] === undefined)
        throw new Error("Item i-object-metdata is missing: "+JSON.stringify(item));
    if (!(item['i-object-metadata'] instanceof Array))
        throw new Error("Item metadata is not an array: "+JSON.stringify(item));
    validateMetadataArray(item['i-object-metadata'], false);
}

function validate_cat(cat) {
    var i;
    if (typeof cat != 'object')
        throw new Error("Catalogue is not an object: "+JSON.stringify(cat));
    if (cat.items === undefined)
        throw new Error("Catalogue items missing: "+JSON.stringify(cat));
    if (!(cat.items instanceof Array))
        throw new Error("Catalogue items are not an array: "+JSON.stringify(cat));
    if (cat['item-metadata'] === undefined)
        throw new Error("Catalogue item-metadata missing: "+JSON.stringify(cat));
    if (!(cat['item-metadata'] instanceof Array))
        throw new Error("Catalogue item-metadata is not an array: "+JSON.stringify(cat));
    validateMetadataArray(cat['item-metadata'], true);
    for (i=0;i<cat.items.length;i++)
        validateItem(cat.items[i]);
}

$(document).ready(function() { 
    $("#validate").click(function() {
        var cat;
        try {
            cat = JSON.parse($('#text').val());
        } catch(e) {
            $('#results').html("Not valid JSON: "+e);
            return;
        }
        try {
            validate_cat(cat);
            $('#results').html("OK");
        } catch(e) {
            $('#results').html(e);
        }
    });
});

</script>
</head>

<body>
<div class="form-group">
    <a href="https://iotblock.io">
    <img src="logo-32x32.png" style="float: right;width:81px;" border=0>
    </a>
    <p>
    <div class="btn-group m-btn-group m-btn-group--pill">
        <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="browser.html">Catalogue browser and editor (text)</a></li>
        <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="explorer.html">Catalogue explorer (graphical)</a></li>
        <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="crawler.html">Catalogue crawler (graphical)</a></li>
        <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="map.html">Client side map demo</a></li>
        <!--
        <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="validator.html">Catalogue syntax validator</a></li>
        //-->
    </div>
    </p>

    </div>
    
<h1>Catalogue Syntax Validator</h1>

<p>
<textarea rows="24" cols="80" id="text">
{
    "item-metadata":[
        {
            "rel":"urn:X-tsbiot:rels:isContentType",
            "val":"application/vnd.tsbiot.catalogue+json"
        },
        {
            "rel":"urn:X-tsbiot:rels:hasDescription:en",
            "val":"A small legal catalogue"
        }
    ],
    "items":[
        {
            "href":"https://iotblock.io/cat",
            "i-object-metadata":[
                {
                    "rel":"urn:X-tsbiot:rels:hasDescription:en",
                    "val":"Thing 1"
                }
            ]
        }
    ]
}
</textarea><br>
<input type="button" class="btn m-btn--pill m-btn--air         btn-outline-info" value="Validate" id="validate">
<div id="results"></div>
<a href="https://iotblock.io/cat"><img src="logo-32x32.png" style="float: right;width:81px;" border=0></a>
</p>


