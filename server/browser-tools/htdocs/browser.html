<html lang="en">
<head>
<link rel="stylesheet" type="text/css" href="css/diQuery-collapsiblePanel.css">
<script src="js/jquery-1.9.1.min.js"></script>
<script src="js/jquery.scrollTo-1.4.2-min.js"></script>
<script type="text/javascript" src="js/URI.js"></script>
<script type="text/javascript" src="js/base64.js"></script>
<script type="text/javascript" src="js/api.js"></script>
<link rel="stylesheet" type="text/css" href="css/style.bundle.css">
<link rel="stylesheet" type="text/css" href="css/vendors.bundle.css">
<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>

<script>
  WebFont.load({
    google: {"families":["Poppins:300,400,500,600,700","Roboto:300,400,500,600,700"]},
    active: function() {
        sessionStorage.fonts = true;
    }
  });
</script>

<script>
var history = [];


function get_url(url) {
    var path=url.replace(/https:\/\/iotblock.io/,'');
    path=path.replace(/http:\/\/localhost:8080/,'');
    path=path.replace(/\/$/, "");
    path=path.replace(/icat/, "cat");
    //alert(path);
    return path;
}

function get_full_url(path) {
    
    return 'https://iotblock.io/' + get_url(path);

}

function deleteCat(cat_url) {
    del(cat_url, $('#key').val(), function(err) {
        if (!err) {
            // go back
            if (history.length > 1) {
                history.pop();  // throw away top
                url = history.pop();
                browse(url, function() {
                    log('browse complete');
                });
            }
        }
    });
}

function deleteItem(cat_url, item_url) {
    var url = cat_url + "?href=" + encodeURI(item_url);
    del(url, $('#key').val(), function(err) {
        if (!err) {
            browse($('#url').val(), function() {
                log('browse complete');
            });
        }
    });
}

// http://stackoverflow.com/questions/5999118/add-or-update-query-string-parameter
function updateQueryStringParameter(uri, key, value) {
    var re = new RegExp("([?|&])" + key + "=.*?(&|$)", "i");
    separator = uri.indexOf('?') !== -1 ? "&" : "?";
    if (uri.match(re)) {
        return uri.replace(re, '$1' + key + "=" + value + '$2');
    }
    else {
        return uri + separator + key + "=" + value;
    }
}

function parseCatalogue(url, doc) {
    var catMetadataListHTML = '<ul>';
    //try {
        // store metadata for catalogue
        console.log(doc);
        for (var i=0;i<doc['catalogue-metadata'].length;i++) {
            catMetadataListHTML += '<li>' + doc['catalogue-metadata'][i].rel + ' = "' + doc['catalogue-metadata'][i].val + '"</li>';
        }
        
    //} catch(e) {
    //    log(e);
    //}
    catMetadataListHTML += '</ul>';

    var urls=[url];
    var itemListHTML = '<ul>';
    //try {
        for (var i=0;i<doc.items.length;i++) {
            var item = doc.items[i];
            item.href = URI(item.href).absoluteTo(url).toString();    // fixup relative URL
            urls.push(item.href);
            var isCat = false;
            var isGenericResource = false;
            var itemMetadataListHTML = '<ul>';
            var supportsQueryOpenIoT = false;
            for (var j=0;j<item['item-metadata'].length;j++) {
                var mdata = item['item-metadata'][j];
                if (mdata.rel == 'urn:X-tsbiot:rels:supports:query' && mdata.val == 'urn:X-tsbiot:query:openiot:v1')
                    supportsQueryOpenIoT = true;
                itemMetadataListHTML += '<li>' + mdata.rel + ' = "' + mdata.val + '"</li>';
                if (mdata.rel == "urn:X-tsbiot:rels:isContentType" && mdata.val == "application/vnd.tsbiot.catalogue+json")
                    isCat = true;
                if (mdata.rel == "urn:X-tsbiot:rels:isContentType" && (mdata.val == "application/senml+json" || mdata.val == "CompositeContentType"))
                    isGenericResource = true;
            }
            itemMetadataListHTML += '</ul>';

            var link;
            if (isCat)
                link = '<a href="javascript:browse(\''+item.href+'\', function(){})">'+item.href+'</a>';
            else
            if (isGenericResource)
                link = '<a href="resourceviewer.html?key='+encodeURIComponent($('#key').val())+'&url='+encodeURIComponent(item.href)+'" target="_blank">'+item.href+'</a>';
            else
                link = '<a href="'+item.href+'">'+item.href+'</a>';

            var editlink = '<a href="itemcreator.html?key='+encodeURIComponent($('#key').val())+'&cat_url='+encodeURI(url)+'&href='+encodeURI(item.href)+'" target="_blank"><strong>[edit item]</strong></a>';
            var deletelink = '<a href="javascript:deleteItem(\''+url+'\',\''+item.href+'\');"><strong>[delete item]</strong></a>';

            var gen_url = function(base, rollup, interval) {
                var rsrcurl = base
                rsrcurl = updateQueryStringParameter(rsrcurl, 'interval', interval);
                rsrcurl = updateQueryStringParameter(rsrcurl, 'rollup', rollup);
                return '<a href="resourceviewer.html?key='+encodeURIComponent($('#key').val())+'&url='+encodeURIComponent(rsrcurl)+'" target="_blank">['+interval+' '+rollup+']</a>';
            }

            if (supportsQueryOpenIoT) {
                itemListHTML += '<li>'+link /*+' '+editlink+' '+deletelink*/;
                itemListHTML += ' ' + gen_url(item.href, "avg", "1d");
                itemListHTML += ' ' + gen_url(item.href, "avg", "1h");
                itemListHTML += ' ' + gen_url(item.href, "avg", "1m");
                itemListHTML += ' ' + gen_url(item.href, "min", "1d");
                itemListHTML += ' ' + gen_url(item.href, "min", "1h");
                itemListHTML += ' ' + gen_url(item.href, "min", "1m");
                itemListHTML += ' ' + gen_url(item.href, "max", "1d");
                itemListHTML += ' ' + gen_url(item.href, "max", "1h");
                itemListHTML += ' ' + gen_url(item.href, "max", "1m");
                itemListHTML += '</li>';
            }
            else
                itemListHTML += '<li>'+link/*+' '+editlink+' '+deletelink*/+'</li>';
            itemListHTML += itemMetadataListHTML;
        }
        itemListHTML += '</ul>';

        var createitemlink = '<a href="itemcreator.html?key='+encodeURIComponent($('#key').val())+'&cat_url='+encodeURI(url)+'" target="_blank"><strong>[add new item]</strong></a>';

        var deletecatlink = '<a href="javascript:deleteCat(\''+url+'\');"><strong>[delete catalogue]</strong></a>';

        var listHTML = '<ul>';
        listHTML += '<li>Catalogue Metadata '/*+deletecatlink*/+'</li>';
        listHTML += catMetadataListHTML;
        listHTML += '<li>Items '+/*createitemlink+*/'</li>'
        listHTML += itemListHTML;
        listHTML += '</ul>';

        populateUrls(urls);
        $('#browser').html(listHTML);
    //} catch(e) {
    //    log(e);
    //}
}

function browse(url, cb) {
    var history=[];
    url=get_url(url);
    //alert(url);
    fetch(url, $('#key').val(), function(err, doc, location) {
        location= get_full_url(location);
        
        if (err) {
            log("Error in "+url+" ("+err+")");
            cb(err); // done
        } else {
            if (location === undefined)
                location = url;
            history.push(location);
            $('#url').val(location);
            parseCatalogue(location, doc);    // parse doc
            cb(null); // done
        }
    });
}



function populateUrls(urls) {

    $("#urls").find('option').remove().end();
    
    //$("#urls").append(new Option('https://iotblock.io/cat/earth', 'https://iotblock.io/cat/earth'));
    for (var i=0; i < urls.length; i++) {
        $("#urls").append(new Option(urls[i], urls[i]));
    }
    $("#urls").append(new Option('https://iotblock.io/cat', 'https://iotblock.io/cat'));

}


var user_item = {
    "item-metadata":[
        {
            "rel":"urn:X-tsbiot:rels:hasDescription:en",
            "val":"A catalogue"
        },
        {
            "rel":"urn:X-tsbiot:rels:isContentType",
            "val":"application/vnd.tsbiot.catalogue+json"
        },
        {
            "rel":"urn:X-tsbiot:rels:supportsSearch",
            "val":"urn:X-tsbiot:search:simple"
        }
    ],
    "items": []
};

function refreshRaw() {
    $('#raw').val(JSON.stringify(user_item, undefined, 4));
}

function populateMetaData() {
    var metadataHTML = '<ul>';
    for (var i=0;i<user_item['item-metadata'].length;i++) {
        var metadataItem = user_item['item-metadata'][i];
        var relHTML = '<input type="text" id="rel_'+i+'" size=40 value="'+metadataItem.rel+'"/>';
        var valHTML = '<input type="text" id="val_'+i+'" size=40 value="'+metadataItem.val+'"/>';
        var metadataItemHTML = relHTML + ' = ' + valHTML;
        var removeButtonHTML = '<input type="button" id="remove_'+i+'" value="X" />'
        metadataItemHTML += removeButtonHTML;
        var divHTML = '<div id="'+'div_'+i+'">' + metadataItemHTML + '</div>';
        metadataHTML += '<li>' + divHTML + '</li>';
    }
    metadataHTML += '</ul>';

    $('#metadata').html(metadataHTML);

    for (var i=0;i<user_item['item-metadata'].length;i++) {
        $('#remove_'+i).click(function() {
            var index = ($(this).attr('id').split('remove_'))[1];
            user_item['item-metadata'].splice(index, 1);
            refreshRaw();
            populateMetaData();
        });
        $('#rel_'+i).on('keyup', function (e) {
            var index = ($(this).attr('id').split('rel_'))[1];
            user_item['item-metadata'][index].rel = $(this).val();
            refreshRaw();
        });
        $('#val_'+i).on('keyup', function (e) {
            var index = ($(this).attr('id').split('val_'))[1];
            user_item['item-metadata'][index].val = $(this).val();
            refreshRaw();
        });
    }
}


$(document).ready(function() { 
    var param_url = getQueryVariable('url');
    var param_key = getQueryVariable('key');
    if (param_key === undefined)
        param_key = "";

    $('#key').val(param_key);
    if (param_url !== undefined) {
        $('#browse_url').val(param_url);
    }

    populateUrls([]);

    populateMetaData();
    $('#add_metadata').click(function() {
        user_item['item-metadata'].push({rel:"", val:""});
        populateMetaData();
    });


    // autoload default
    /*
    browse($('#browse_url').val(), function() {
        log('browse complete');
    });
    */



    $('#urls').on('change', function (e) {
        var optionSelected = $("option:selected", this);
        var valueSelected = this.value;
        $('#browse_url').val(this.value);
        $('#new_url').val(this.value + '/<catalogue_name>');
        var url=this.value;
        var path=url.replace(/https:\/\/iotblock.io/,'');
        
        url=url.replace(/\/$/, "");
        url=url.replace(/icat/, "cat");
        url="https://iotblock.io" + path
        path=path.replace(/\/$/, "");
        path=path.replace(/icat/, "cat");
        
        browse($('#browse_url').val(), function() {
            log('browse complete');
        });
        
        /*
        
        get_graph(url, path).then(function(pas212Root) {
            var hyperJson=JSON.stringify(pas212Root, null, 4);
            $('.catalogue').html("<pre><code>" + hyperJson + "</code></pre>");
        });
        
        */ 
    
    });


    $('#post_item').click(function() {
        $('#start_catalogue').hide();
        $('#loading').show();
        
                        
        function callback(graphNode) {
            alert(graphNode);
        }
        //add_node('', url, callback); 
        
        var parent_address = $('#browse_url').val();
        var url = $('#new_url').val();
        var key = $('#key').val();
        $.ajax({
            //beforeSend: function(xhr){setHeaders(xhr);},
            type: 'GET',
            url: '/cat/post?parent_href=' + encodeURI(parent_address) + '&href=' + encodeURI(url) + '&key=' + key,
            data: JSON.stringify(user_item),
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            success: function(body, textStatus, xhr) {
                                
                $('#browse_url').val(url);
                $('#new_url').val(url + '/<catalogue_name>');
                
                
                url=url.replace(/\/$/, "");
                url=url.replace(/icat/, "cat");
                
                
                console.log(url); 
        
                browse($('#browse_url').val(), function() {
                    log('browse complete');
                });
                $('#loading').hide();
                $('#start_catalogue').show();
                
                log(xhr.status + ' ' + xhr.statusText);
            },
            error: function(xhr, textStatus, err) {
                log(xhr.status + ' ' + xhr.statusText);
            }
        });
        
    });
    
    
    $("#newcat").click(function() {
        window.open('catcreator.html?key='+encodeURIComponent($('#key').val())+'&cat_url='+encodeURI("https://iotblock.io/cat"), "_blank");
    });

    $("#back").click(function() {
        if (history.length > 1) {
            history.pop();  // throw away top
            url = history.pop();
            browse(url, function() {
                log('browse complete');
            });
        }
    });

    $('#urls').trigger('change');
});

</script>
</head>

<body>
<form id="header">
<div class="row">
     <div class="col-md-12">
         <center>
          <a href="https://iotblock.io">
        <img src="logo-32x32.png" style="float: right;width:81px;" border=0>
        </a>
        <div class="btn-group m-btn-group m-btn-group--pill">
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="pool.html">Smart Pool Key</a>
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="key.html">Smart Key</a>
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="browser.html">Catalogue browser and editor (text)</a>
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="explorer.html">Catalogue explorer (graphical)</a>
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="crawler.html">Catalogue crawler (graphical)</a>
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="map.html">Catalogue Map</a>
            <!--
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="validator.html">Catalogue syntax validator</a></li>
            //-->
        </div>
           </center>
    </div>
</div>
</form>

<form id="page2">
    

<div class="row">
<div class="col-md-6">
        <h1>Catalogue Browser</h1>
        <form class="form-group">
            <div class="row">
                <div class="col-md-6">
                    
                    <h3>Select Catalogue:
                    </h3>
                    <select id="urls" class="form-control m-input m-input--air"></select>
                    
                </div>
                <div class="col-md-6">
                    
                    <h3>Catalogue URL:
                    </h3>
                    <input class="form-control m-input m-input--air" type="text" id="browse_url" size=80 value="https://iotblock.io/cat" />
                
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <br>
                    <!--
                    <h3>Key
                    </h3>
                    <input class="form-control m-input m-input--air" type="password" id="key" size=40 value="" />
                    //-->
                    <br>
                    <div id="browser"></div>
                    <h1>Metadata Editor</h1>
                    
                        <hr>
                        <p>
                            <div id="metadata"></div>
                            <input type="button" id="add_metadata"  class="btn m-btn--pill m-btn--air         btn-outline-info"  i value="Add more metadata" /><br>
                        </p>
                        <hr>

                    </div>
            </div>
        </form>

    </div><div class="col-md-6">
        <h1>Start a Catalogue</h1>
        <form id="start_catalogue">
        <p>
            <h3>URL to Add to Catalogue:</h3>
            <input  class="form-control m-input m-input--air"  type="text" id="new_url" size=80 value="" />
            <br>
            <h3>Key&nbsp;</h3>
            <span class="key"></span>
            <input  class="key_val form-control m-input m-input--air"  id="key"  size=40 value="" />
            <br>
            <input type="button" class="btn m-btn--pill m-btn--air         btn-outline-info"  id="post_item" value="Add a Catalogue" />
        </p>    
        </form>
        <form id="loading" style="display:none;">
        <img src="images/wait.gif">
        </form>

            
    </div><div class="col-md-6">

        <p>
            <div id="log"></div>
        </p>
        
    </div></div>
</form>
        
            
        
        <p>
            <div id="log"></div>
        </p>

    </div>
    <div class="col-md-6">
        <p>
        </p>
        
        <div class="catalogue"></div>
    </div>
    </div>
    <a href="https://iotblock.io"><img src="logo-32x32.png" style="float: right;width:81px;" border=0></a>
    
<script>
var isBrowse=true;
var isSmartKey=true;

function fill_page2(address, eth_sent, vault, state, health) {

    if (address == '0x0000000000000000000000000000000000000000') {
        $('#page1').show();
        $('#page2').hide();
        $('#loading').hide();
    } else {
        $('#page1').hide();
        $('#page2').show();
        $('#loading').hide();
       
       $('.key').html(address);
       $('.key_val').val(address);
         
        $('#send_ether').on('click', function(e) {
               var eth1=1000000000000000000;
               var amt=parseInt($('#send_amt').val()) * eth1;
               send_ether(address, amt);
       });       
   }
   //get_pool_transactions(address, fill_page2_transactions);

   console.log(address, eth_sent, vault, state);
   
}  

</script>
<script src="js/app.js"></script>
</body>

</html>
