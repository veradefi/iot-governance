<html lang="en">
<head>
<link rel="stylesheet" type="text/css" href="css/diQuery-collapsiblePanel.css">
<link rel="stylesheet" type="text/css" href="css/style.css">
<script src="js/jquery-1.9.1.min.js"></script>
<script src="js/jquery.scrollTo-1.4.2-min.js"></script>
<script type="text/javascript" src="js/URI.js"></script>
<script type="text/javascript" src="js/base64.js"></script>
<script type="text/javascript" src="js/api.js"></script>
<link rel="stylesheet" type="text/css" href="css/style.bundle.css">
<link rel="stylesheet" type="text/css" href="css/vendors.bundle.css">
<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>
        <script>
          WebFont.load({
            google: {"families":["Poppins:300,400,500,600,700","Roboto:300,400,500,600,700"]},
            active: function() {
                sessionStorage.fonts = true;
            }
          });
        </script>


<script>
var user_item = {
    "item-metadata":[
        {
            "rel":"urn:X-tsbiot:rels:hasDescription:en",
            "val":"A catalogue"
        },
        {
            "rel":"urn:X-tsbiot:rels:isContentType",
            "val":"application/vnd.tsbiot.catalogue+json"
        },
        {
            "rel":"urn:X-tsbiot:rels:supportsSearch",
            "val":"urn:X-tsbiot:search:simple"
        }
    ],
    "items": []
};

function refreshRaw() {
    $('#raw').val(JSON.stringify(user_item, undefined, 4));
}

function populateItem() {
    var metadataHTML = '<ul>';
    for (var i=0;i<user_item['item-metadata'].length;i++) {
        var metadataItem = user_item['item-metadata'][i];
        var relHTML = '<input type="text" id="rel_'+i+'" size=40 value="'+metadataItem.rel+'"/>';
        var valHTML = '<input type="text" id="val_'+i+'" size=40 value="'+metadataItem.val+'"/>';
        var metadataItemHTML = relHTML + ' = ' + valHTML;
        var removeButtonHTML = '<input type="button" id="remove_'+i+'" value="X" />'
        metadataItemHTML += removeButtonHTML;
        var divHTML = '<div id="'+'div_'+i+'">' + metadataItemHTML + '</div>';
        metadataHTML += '<li>' + divHTML + '</li>';
    }
    metadataHTML += '</ul>';

    $('#metadata').html(metadataHTML);

    for (var i=0;i<user_item['item-metadata'].length;i++) {
        $('#remove_'+i).click(function() {
            var index = ($(this).attr('id').split('remove_'))[1];
            user_item['item-metadata'].splice(index, 1);
            refreshRaw();
            populateItem();
        });
        $('#rel_'+i).on('keyup', function (e) {
            var index = ($(this).attr('id').split('rel_'))[1];
            user_item['item-metadata'][index].rel = $(this).val();
            refreshRaw();
        });
        $('#val_'+i).on('keyup', function (e) {
            var index = ($(this).attr('id').split('val_'))[1];
            user_item['item-metadata'][index].val = $(this).val();
            refreshRaw();
        });
    }
}

function setHeaders(xhr) {
    if ($('#key').val() !== "") {
        xhr.setRequestHeader("Authorization", "Basic " + Base64.encode($('#key').val() + ':'));
        return true;
    }
}

$(document).ready(function() { 
    populateItem();
    refreshRaw();

    var param_cat_url = getQueryVariable('cat_url');
    var param_key = getQueryVariable('key');
    if (param_cat_url !== undefined)
        $('#cat_url').val(param_cat_url);
    $('#key').val(param_key);

    $('#add_metadata').click(function() {
        user_item['item-metadata'].push({rel:"", val:""});
        populateItem();
    });

    $('#post_item').click(function() {
        var url = $('#cat_url').val();
        $.ajax({
            beforeSend: function(xhr){setHeaders(xhr);},
            type: 'POST',
            url: '/post?url=' + encodeURI(url),
            data: JSON.stringify(user_item),
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            success: function(body, textStatus, xhr) {
                log(xhr.status + ' ' + xhr.statusText);
            },
            error: function(xhr, textStatus, err) {
                log(xhr.status + ' ' + xhr.statusText);
            }
        });
    });

    $('#examples').on('change', function (e) {
        var optionSelected = $("option:selected", this);
        var valueSelected = this.value;
        $('#url').val(this.value);
    });

    $("#go").click(function() {
        browse($('#url').val(), function() {
            log('browse complete');
        });
    });

    $("#back").click(function() {
        if (history.length > 1) {
            history.pop();  // throw away top
            url = history.pop();
            browse(url, function() {
                log('browse complete');
            });
        }
    });
});

</script>
</head>

<body>
<form id="header">
<div class="row">
     <div class="col-md-12">
         <center>
          <a href="https://iotblock.io">
        <img src="logo-32x32.png" style="float: right;width:81px;" border=0>
        </a>
        <div class="btn-group m-btn-group m-btn-group--pill">
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="pool.html">Smart Pool Key</a>
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="key.html">Smart Key</a>
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="browser.html">Catalogue browser and editor (text)</a>
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="explorer.html">Catalogue explorer (graphical)</a>
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="crawler.html">Catalogue crawler (graphical)</a>
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="map.html">Catalogue Map</a>
            <!--
            <a class="btn m-btn--pill m-btn--air         btn-outline-info" href="validator.html">Catalogue syntax validator</a></li>
            //-->
        </div>
           </center>
    </div>
</div>
</form>
    
    <h1>Catalogue Creator</h1>
    <div class="row"><div class="col-md-6">
        <p>A simple tool to allow creation of empty catalogues</p>
        <hr>
        <p>
            <div id="metadata"></div>
            <input type="button" id="add_metadata"  class="btn m-btn--pill m-btn--air         btn-outline-info"  i value="Add more metadata" /><br>
        </p>
        <hr>
        <p>
            <h3>URL&nbsp;</h3>
            <input  class="form-control m-input m-input--air"  type="text" id="cat_url" size=80 value="" />
            <h3>Key&nbsp;</h3>
            <input  class="form-control m-input m-input--air"  type="password" id="key" size=40 value="" />
            <input type="button" class="btn m-btn--pill m-btn--air         btn-outline-info"  id="post_item" value="Post" />
        </p>
    </div><div class="col-md-6">

        <p>
            <div id="log"></div>
            <textarea disabled readonly id="raw" cols=80 rows=30></textarea>
        </p>
    </div></div>

</body>

</html>
